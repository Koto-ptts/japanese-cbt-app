{% extends 'cbt_app/base.html' %}
{% load static %}

{% block title %}å•é¡Œ{{ question.order }} - {{ question.text.title }}{% endblock %}

{% block content %}
<div class="row">
    {% if show_text %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>{{ question.text.title }}</h5>
                    {% if question.text.author %}
                        <small class="text-muted">ä½œè€…: {{ question.text.author }}</small>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="text-content">
                        {{ question.text.content|linebreaks }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
    {% else %}
        <div class="col-md-12">
            <div class="alert alert-warning text-center mb-4">
                <h5>ğŸ“µ æ–‡ç« éè¡¨ç¤ºå•é¡Œ</h5>
                <p>ã“ã®å•é¡Œã§ã¯æ–‡ç« ã‚’å‚ç…§ã§ãã¾ã›ã‚“ã€‚</p>
                {% if allow_notes_only %}
                    <p><strong>ã‚ãªãŸãŒä½œæˆã—ãŸãƒ¡ãƒ¢ã®ã¿å‚ç…§å¯èƒ½ã§ã™ã€‚</strong></p>
                    <button class="btn btn-info" onclick="showMemos()">ğŸ“ ãƒ¡ãƒ¢ã‚’ç¢ºèª</button>
                {% endif %}
            </div>
    {% endif %}
    
            <div class="card">
                <div class="card-header">
                    <h4>å•é¡Œ {{ question.order }}</h4>
                </div>
                <div class="card-body">
                    <div class="question-text mb-4">
                        {{ question.question_text|linebreaks }}
                    </div>
                    
                    <form method="post">
                        {% csrf_token %}
                        
                        {% if question.question_type == 'choice' %}
                            <!-- é¸æŠå•é¡Œ -->
                            {% for choice in question.choices.all %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" 
                                           name="selected_choice" value="{{ choice.id }}" 
                                           id="choice{{ choice.id }}"
                                           {% if response.selected_choice.id == choice.id %}checked{% endif %}>
                                    <label class="form-check-label" for="choice{{ choice.id }}">
                                        {{ choice.choice_text }}
                                    </label>
                                </div>
                            {% endfor %}
                        {% else %}
                            <!-- è¨˜è¿°å•é¡Œ -->
                            <div class="mb-3">
                                <label for="response_text" class="form-label">å›ç­”</label>
                                <textarea class="form-control" id="response_text" name="response_text" 
                                          rows="8" placeholder="ã“ã“ã«å›ç­”ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„...">{% if response %}{{ response.response_text }}{% endif %}</textarea>
                            </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">å›ç­”ã‚’ä¿å­˜</button>
                            <a href="{% url 'cbt_app:text_detail' question.text.id %}" class="btn btn-secondary">å•é¡Œä¸€è¦§ã«æˆ»ã‚‹</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
</div>

<!-- ãƒ¡ãƒ¢è¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="memosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“ ã‚ãªãŸãŒä½œæˆã—ãŸãƒ¡ãƒ¢</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="memosContent">
                <!-- ãƒ¡ãƒ¢ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function showMemos() {
    fetch(`/api/get-all-memos/{{ question.text.id }}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMemos(data.memos);
                new bootstrap.Modal(document.getElementById('memosModal')).show();
            }
        });
}

function displayMemos(memos) {
    const content = document.getElementById('memosContent');
    if (memos.length === 0) {
        content.innerHTML = '<p class="text-muted">ã¾ã ãƒ¡ãƒ¢ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
        return;
    }
    
    const groupedMemos = {};
    memos.forEach(memo => {
        if (!groupedMemos[memo.type]) {
            groupedMemos[memo.type] = [];
        }
        groupedMemos[memo.type].push(memo);
    });
    
    let html = '';
    Object.keys(groupedMemos).forEach(type => {
        const typeLabel = getTypeLabel(type);
        html += `<h6>${typeLabel}</h6>`;
        groupedMemos[type].forEach(memo => {
            html += `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6 class="card-title">${memo.title}</h6>
                        <p class="card-text">${formatMemoContent(memo)}</p>
                        <small class="text-muted">${new Date(memo.created_at).toLocaleString('ja-JP')}</small>
                    </div>
                </div>
            `;
        });
    });
    
    content.innerHTML = html;
}

function getTypeLabel(type) {
    const labels = {
        'paragraph': 'ğŸ“ æ®µè½å®šç¾©',
        'logic-structure': 'ğŸ”— è«–ç†æ§‹é€ åˆ†æ',
        'causal-map': 'âš¡ å› æœé–¢ä¿‚ãƒãƒƒãƒ—',
        'concept-map': 'ğŸ—ºï¸ æ¦‚å¿µãƒãƒƒãƒ—',
        'argument-analysis': 'âš–ï¸ è«–è¨¼æ§‹é€ åˆ†æ',
        'perspective-analysis': 'ğŸ‘ï¸ å¤šè§’çš„è¦–ç‚¹åˆ†æ'
    };
    return labels[type] || type;
}

function formatMemoContent(memo) {
    if (memo.content) return memo.content;
    
    const data = memo.data;
    switch (memo.type) {
        case 'logic-structure':
            return `é–¢ä¿‚: ${data.logicType}<br>åˆ†æ: ${data.description}`;
        case 'causal-map':
            return `åŸå› : ${data.cause}<br>çµæœ: ${data.effect}`;
        default:
            return JSON.stringify(data);
    }
}
</script>
{% endblock %}
